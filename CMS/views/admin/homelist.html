<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查看导航</title>
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./lib/layui/layui/css/layui.css">
</head>
<style>
  .layui-table-cell{
    height:60px;
  }
</style>
<body>
    <div class="layui-card">
        <div class="layui-card-header">
            <span class="layui-breadcrumb">
                <a href="">房源管理</a>
                <a><cite>编辑房源</cite></a>
              </span>
        </div>
        <div class="layui-card-body">
          <form class="layui-form" action="">
            <div class="layui-inline">
                <div class="layui-input-inline" style="width: 300px;">
                    <input type="text" name="search" placeholder="请输入房源名称" autocomplete="off" class="layui-input" >
                  </div>
                   <button type="button" class="layui-btn"  lay-submit lay-filter="search"><i class="layui-icon layui-icon-search"></i> 搜索</button>
            </div>
          </form>
        </div>
        </div>
        <table  class="layui-table tableRender" lay-filter="roles" id="tableAll">

          </table>
     </div>
      <!-- 弹出层 -->
     <div id="updateBox" style="display:none;">
      <form class="layui-form" action="" >
       <!-- 隐藏域 --> 
       <input type="hidden" name="home_id">
       <div class="layui-form-item">
         <label class="layui-form-label">房源名称</label>
         <div class="layui-input-block">
           <input type="text" name="home_name" required  lay-verify="required"  autocomplete="off" class="layui-input">
         </div>
       </div>
       <div class="layui-form-item">
         <label class="layui-form-label">房源位置</label>
         <div class="layui-input-block">
           <input type="text" name="home_location" required  lay-verify="required" autocomplete="off" class="layui-input">
         </div>
       </div>
       <div class="layui-form-item">
         <div class="layui-input-block">
           <button class="layui-btn updateBox1" lay-submit lay-filter="updateForm" >立即提交</button>
           <button type="reset" class="layui-btn layui-btn-primary">重置</button>
         </div>
       </div>
     </form>
   </div>

</body>
</html>
<script type="text/html" id="title2">
   <div>
    <a href="#"><i onclick="deleteHome('{{d.home_id}}','{{d.home_img}}')" class="layui-icon layui-icon-delete"></i></a>
     <a href="javascript:;" ><i lay-event="read" class="layui-icon layui-icon-list" ></i></a>
    <a href="#"><i onclick="updateHome('{{d.home_id}}')" class="layui-icon layui-icon-edit"></i></a>
  </div>           
</script>
<script  type="text/html" id="title3">
  <div>
    <input  type="text" onchange="updateSort('{{d.home_id}}',this)" value="{{d.home_sort}}" style="width:30px;text-align: center;">
  </div>
</script>
<script src="./lib/layui/layui/layui.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
         var $,layer,tableIns,form;
         //修改排序
         function updateSort(id,obj){
      $.get(`/admin/home/update?id=${id}&sort=${obj.value}`,(res)=>{
      let {code,msg}=res;
      if(code==1){
        tableIns.reload();
      }
      layer.msg(msg);
    }) 
  }

  //删除
  function deleteHome(id,img){
      var index=layer.open({
        title:'删除操作',
        content: '您确定要执行删除操作吗？'
        ,btn: ['确定', '取消']
        ,yes: function(index, layero){
          //按钮【按钮一】的回调
          $.ajax({
          type:'get',
          url:`/admin/home/delete?id=${id}`,
          dataType:"json",
          success:function(res){
              if(res.code==1){
                tableIns.reload(); 
              }
              layer.msg(res.msg);
              layer.close(index);
          }
         })
          }
          ,btn2: function(index, layero){
          }
          ,cancel: function(){ 
          }   
        })
        }       

  //整体修改
  function updateHome(id){
      var index;
      $.get(`/admin/home/updateAll?id=${id}`,(res)=>{
        index= layer.open({
            title:"修改房源",
            type:1,
            content:$("#updateBox")
           })
    let data=res.data;
    $("[name=home_name]").val(data.home_name);
    $("[name=home_location]").val(data.home_location);
    $("[name=home_id]").val(data.home_id);
    form.on("submit(updateForm)",(data)=>{
      $.ajax({
        url:"/admin/home/updateAll",
        type:"post",
        data:data.field,
        dataType:"json",
        success:(res)=>{
          let {code,msg}=res;
          if(code==1){
            //关闭窗口,表格重载,隐藏表单
            layer.close(index);
            tableIns.reload();
             $("#updateBox").toggle();
          }
          layer.msg(msg);
        }
      })
      return false;
    })  
  })
}

    layui.use(['element','form','jquery','layer','table'], function(){
        var {element,table} = layui;
        $=layui.$,layer=layui.layer,form=layui.form;
        tableIns=table.render({
        elem: '.tableRender'
        ,url: '/admin/home/query' //数据接口
        ,cols: [[ //表头
          {field: 'home_id', title: 'ID', width:80, sort: true},
          {field: 'home_name', title: '房源名称'},
          {field: 'home_location', title: '房源位置'} ,
          {field: 'home_price', title: '房源价格'},
          {field: 'home_sort', title: '房源排序',templet:"#title3"},
          {field: 'home_img', title: '房源图片',templet:function(d){
              return `<div><img src="${d.home_img}" alt="" ></div>`
          }},
          {field: 'ctime', title: '房源创建时间'},
          {field: '', title: '操作',templet:"#title2"}
        ]],
        limit:5,
        page:true,
        limits:[5,10,15,20]
         })  
         //表格行事件
      table.on('tool(roles)', function(obj){
        console.log(obj);
       switch (obj.event){
          case "read":
          location.href=`/admin/home/list?id=${obj.data.home_id}`;
            break;
        } 
      });
         
      //搜索
      form.on("submit(search)",function(data){
        tableIns.reload({
         where: { //设定异步数据接口的额外参数
          search:data.field.search
         },
       page: {
       curr: 1 //重新从第 1 页开始
         }
       })
      })
     })
</script>